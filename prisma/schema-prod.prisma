generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                  String               @id @default(cuid())
  name                String
  slug                String               @unique
  settings            String               @default("{}")
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  clients             Client[]
  contacts            Contact[]
  devices             Device[]
  drivers             Driver[]
  locations           Location[]
  logisticsOfficers   LogisticsOfficer[]
  manifestAudits      ManifestAudit[]
  manifestLocations   ManifestLocation[]
  manifests           Manifest[]
  offenses            Offense[]
  organizations       Organization[]
  routes              Route[]
  userProfiles        UserProfile[]
  users               User[]
  vehicleCombinations VehicleCombination[]
  vehicles            Vehicle[]
  whatsappData        WhatsappData[]
  whatsappFiles       WhatsappFile[]
  whatsappLocations   WhatsappLocation[]
  whatsappMedia       WhatsappMedia[]

  @@map("tenants")
}

model Organization {
  id        String    @id @default(cuid())
  tenantId  String
  name      String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  companies Company[]
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("organizations")
}

model Company {
  id           String       @id @default(cuid())
  orgId        String
  name         String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  drivers      Driver[]
  manifests    Manifest[]
  vehicles     Vehicle[]

  @@map("companies")
}

model User {
  id           String       @id @default(cuid())
  tenantId     String
  email        String       @unique
  name         String?
  passwordHash String?
  role         String       @default("USER")
  tenantSlug   String?
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  tenant       Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  clientAccess UserClient[]
  images       UserImage[]

  @@map("users")
}

model Client {
  id                    String       @id @default(cuid())
  tenantId              String
  companyId             Int          @unique
  companyTypeId         Int?
  entityTypeDescription String
  name                  String
  address               String?
  displayValue          String
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  tenant                Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userAccess            UserClient[]

  @@map("clients")
}

model UserClient {
  id        String   @id @default(cuid())
  userId    String
  clientId  String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([userId, clientId])
  @@map("user_clients")
}

model UserImage {
  id        String   @id @default(cuid())
  userId    String
  type      String   // 'photo', 'id', 'passport'
  uri       String
  mimeType  String?
  sizeBytes Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_images")
}

model Driver {
  id              String    @id @default(cuid())
  tenantId        String
  companyId       String?
  driverId        Int       @unique
  name            String
  contactNr       String?
  idNumber        String
  pictureLoaded   Boolean   @default(false)
  countryOfOrigin String
  displayValue    String
  info            String?
  active          Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  company         Company?  @relation(fields: [companyId], references: [id])
  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  offenses        Offense[]

  @@map("drivers")
}

model Vehicle {
  id                    String                      @id @default(cuid())
  tenantId              String
  companyId             String?
  vehicleId             Int                         @unique
  vehicleTypeId         Int?
  entityTypeDescription String
  registration          String
  color                 String?
  countryOfOrigin       String
  displayValue          String
  mileage               Int?
  lastServiceDate       DateTime?
  nextServiceDue        DateTime?
  status                String                      @default("Active")
  currentDriver         String?
  location              String?
  lastSeen              String?
  trackerDeviceId       String?
  createdAt             DateTime                    @default(now())
  updatedAt             DateTime                    @updatedAt
  fuelEntries           FuelEntry[]
  manifests             Manifest[]
  offenses              Offense[]
  trailerCombinations   VehicleCombinationTrailer[] @relation("TrailerCombinations")
  horseCombinations     VehicleCombination[]        @relation("HorseCombinations")
  company               Company?                    @relation(fields: [companyId], references: [id])
  tenant                Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("vehicles")
}

model VehicleCombination {
  id        String                      @id @default(cuid())
  tenantId  String
  horseId   String
  driver    String
  status    String                      @default("Active")
  startDate DateTime
  cargo     String?
  route     String?
  createdAt DateTime                    @default(now())
  updatedAt DateTime                    @updatedAt
  trailers  VehicleCombinationTrailer[]
  horse     Vehicle                     @relation("HorseCombinations", fields: [horseId], references: [id], onDelete: Cascade)
  tenant    Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("vehicle_combinations")
}

model VehicleCombinationTrailer {
  id            String             @id @default(cuid())
  combinationId String
  trailerId     String
  createdAt     DateTime           @default(now())
  trailer       Vehicle            @relation("TrailerCombinations", fields: [trailerId], references: [id], onDelete: Cascade)
  combination   VehicleCombination @relation(fields: [combinationId], references: [id], onDelete: Cascade)

  @@unique([combinationId, trailerId])
  @@map("vehicle_combination_trailers")
}

model FuelEntry {
  id              String   @id @default(cuid())
  vehicleId       String
  date            DateTime
  amount          Float
  cost            Float
  driver          String
  odometerReading Int
  location        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  vehicle         Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@map("fuel_entries")
}

model Manifest {
  id              String             @id @default(cuid())
  tenantId        String
  title           String?
  status          String             @default("SCHEDULED")
  scheduledAt     DateTime?
  trackingId      String?            @unique @map("trackingID")
  tripStateId     Int?               @map("tripStateID")
  routeId         String?            @map("routeID")
  clientId        String?            @map("clientID")
  transporterId   String?            @map("transporterID")
  companyId       String?            @map("companyID")
  horseId         String?            @map("horseID")
  trailerId1      String?            @map("trailerID1")
  trailerId2      String?            @map("trailerID2")
  locationId      String?            @map("locationID")
  parkLocationId  String?            @map("parkLocationID")
  countryId       Int?               @map("countryID")
  invoiceStateId  String?            @map("invoiceStateID")
  invoiceNumber   String?            @map("invoiceNumber")
  rmn             String?
  jobNumber       String?
  dateTimeAdded   DateTime           @default(now()) @map("dateTimeAdded")
  dateTimeUpdated DateTime?          @updatedAt @map("dateTimeLastUpdate")
  dateTimeEnded   DateTime?          @map("dateTimeEnded")
  audits          ManifestAudit[]
  locations       ManifestLocation[]
  horse           Vehicle?           @relation(fields: [horseId], references: [id])
  parkLocation    Location?          @relation("Manifest_parkLocationId", fields: [parkLocationId], references: [id])
  location        Location?          @relation("Manifest_locationId", fields: [locationId], references: [id])
  invoiceState    InvoiceState?      @relation(fields: [invoiceStateId], references: [id])
  route           Route?             @relation(fields: [routeId], references: [id])
  company         Company?           @relation(fields: [companyId], references: [id])
  tenant          Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  whatsapp        WhatsappData[]

  @@index([tenantId, dateTimeUpdated])
  @@map("manifests")
}

model ManifestLocation {
  id         String    @id @default(cuid())
  tenantId   String
  manifestId String
  locationId String?
  latitude   Float
  longitude  Float
  recordedAt DateTime  @default(now())
  location   Location? @relation(fields: [locationId], references: [id])
  manifest   Manifest  @relation(fields: [manifestId], references: [id], onDelete: Cascade)
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("manifest_locations")
}

model InvoiceState {
  id        String     @id @default(cuid())
  name      String     @unique
  code      String     @unique
  manifests Manifest[]

  @@map("invoicestates")
}

model Route {
  id          String     @id @default(cuid())
  tenantId    String
  name        String
  description String?
  startPoint  String?
  endPoint    String?
  distance    Float?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  manifests   Manifest[]
  tenant      Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@map("routes")
}

model Location {
  id                String             @id @default(cuid())
  tenantId          String
  locationId        Int?               @unique
  countryId         Int?
  name              String
  description       String?
  latitude          Float?
  longitude         Float?
  address           String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  manifestLocations ManifestLocation[]
  parkManifests     Manifest[]         @relation("Manifest_parkLocationId")
  manifests         Manifest[]         @relation("Manifest_locationId")

  @@unique([tenantId, name])
  @@map("locations")
}

model WhatsappData {
  id         String             @id @default(cuid())
  tenantId   String
  manifestId String?
  manifest   Manifest?          @relation(fields: [manifestId], references: [id])
  tenant     Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  files      WhatsappFile[]
  locations  WhatsappLocation[]
  media      WhatsappMedia[]

  @@index([tenantId, manifestId])
  @@map("whatsapp_data")
}

model WhatsappFile {
  id             String       @id @default(cuid())
  tenantId       String
  whatsappDataId String
  fileName       String
  uri            String
  mimeType       String?
  sizeBytes      Int?
  checksum       String?
  parent         WhatsappData @relation(fields: [whatsappDataId], references: [id], onDelete: Cascade)
  tenant         Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, whatsappDataId])
  @@map("whatsapp_files")
}

model WhatsappLocation {
  id             String       @id @default(cuid())
  tenantId       String
  whatsappDataId String
  latitude       Float
  longitude      Float
  thumbnailUri   String?
  parent         WhatsappData @relation(fields: [whatsappDataId], references: [id], onDelete: Cascade)
  tenant         Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, whatsappDataId])
  @@map("whatsapp_location")
}

model WhatsappMedia {
  id             String       @id @default(cuid())
  tenantId       String
  whatsappDataId String
  extension      String?
  link           String?
  uri            String
  mimeType       String?
  sizeBytes      Int?
  checksum       String?
  parent         WhatsappData @relation(fields: [whatsappDataId], references: [id], onDelete: Cascade)
  tenant         Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, whatsappDataId])
  @@map("whatsapp_media")
}

model UserProfile {
  id       String       @id @default(cuid())
  tenantId String
  fullName String
  picture  UserPicture?
  tenant   Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, fullName])
  @@map("userprofiles")
}

model UserRole {
  id   String @id @default(cuid())
  name String @unique
  code String @unique

  @@map("userroles")
}

model UserPicture {
  id        String      @id @default(cuid())
  profileId String      @unique
  uri       String
  mimeType  String?
  sizeBytes Int?
  checksum  String?
  profile   UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@map("userpictures")
}

model ManifestAudit {
  id         String   @id @default(cuid())
  tenantId   String
  manifestId String
  action     String
  oldValues  String
  newValues  String
  createdAt  DateTime @default(now())
  manifest   Manifest @relation(fields: [manifestId], references: [id], onDelete: Cascade)
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("manifest_audits")
}

model Offense {
  id        String   @id @default(cuid())
  tenantId  String
  driverId  String?
  vehicleId String?
  kind      String
  severity  String   @default("MINOR")
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  vehicle   Vehicle? @relation(fields: [vehicleId], references: [id])
  driver    Driver?  @relation(fields: [driverId], references: [id])

  @@map("offenses")
}

model Attachment {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  url        String
  mime       String
  meta       String   @default("{}")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("attachments")
}

model WebhookEvent {
  id          String    @id @default(cuid())
  source      String
  payload     String
  processedAt DateTime?
  status      String    @default("PENDING")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("webhook_events")
}

model Device {
  id            String         @id @default(cuid())
  tenantId      String
  externalId    String         @unique
  lastPingAt    DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  locationPings LocationPing[]

  @@map("devices")
}

model LocationPing {
  id        String   @id @default(cuid())
  deviceId  String
  lat       Float
  lng       Float
  speed     Float?
  heading   Float?
  timestamp DateTime
  createdAt DateTime @default(now())
  device    Device   @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  @@map("location_pings")
}

model Country {
  id            Int       @id @default(autoincrement())
  name          String
  abbreviation  String
  dateTimeAdded DateTime? @default(now())
  displayValue  String
  flag          String?

  @@map("countries")
}

model Contact {
  id              String   @id @default(cuid())
  tenantId        String
  contactId       Int?     @unique
  name            String
  contactNr       String
  idNumber        String
  pictureLoaded   Boolean  @default(false)
  countryOfOrigin String
  displayValue    String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, name])
  @@map("contacts")
}

model LogisticsOfficer {
  id                 String   @id @default(cuid())
  tenantId           String
  logisticsOfficerId Int?     @unique
  name               String
  contactNr          String?
  idNumber           String?
  pictureLoaded      Boolean  @default(false)
  countryOfOrigin    String?
  displayValue       String?
  role               String?
  email              String?
  phone              String?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  tenant             Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, name])
  @@map("logistics_officers")
}
